Billing
===========

Для корректной работы биллинга необходимо скомпилировать и установить модуль ams_cdr_mysql.so из пакета ams-modules.
После установки нужно в файле ams.conf в секции [global] установить параметры соединения с базой данных mysql 
(hostname, dbname, user, password, port, sock).
Параметры, указанные в ams.conf и параметры соединения в файле config.php должны указывать на одну базу данных.
Они одинаковые, если Астериск, база данных и web-сервер работают на одном компьютере. 
Установить параметры в секции

[billing]

billing_enable=1
tables_in_memory=1 ; 0-используются обычные таблицы, 1- необходимые для работы биллинга таблицы копируется в память, 
;что позволяет ускорить время выборки ~ на 30%. Необходимо помнить, что в этом случае требуется 
;перезагрузить конфигурацию Астериска после внесения изменений в тарифы или тарифные планы, для того, чтобы
;эти изменения вошли в силу

Биллинг работает следующим образом.
При создании Тарифных планов (модуль Тарифные Планы) задается уникальный идентификатор AccountCode.
Звонок, имеющий в момент завершения параметр accountcode,совпадающий с идентификатором Тарифного плана
будет считаться, соответствующим данному Тарифному плану.
AccountCode тарифного плана может либо полностью совпадать с accountcode звонка, либо являться его подстрокой.
Например, если создан тарифный план Test Plan с AccountCode = test.

extensions.conf
----------------

exten => 100,1,Set(CDR(accountcode)=test) ;этот звонок будет соответствовать тарифному плану Test Plan

exten => 200,1,Set(CDR(accountcode)=test-123) ; этот тоже

Тарифные планы могут быть в разных валютах. Валюты можно добавлять, редактировать курсы в модуле Валюты.

При создании тарифных планов можно задать правила трансляции префиксов. Эти правила нужны, когда пользователь 
набирает номер в одном формате, а в тарифном плане используется другой формат записи.
Например, в тарифном плане задан тариф 7495 - Russia Moscow, а пользователь набирает в привычном формате 8495....
Тогда в тарифном плане нужно задать правило трансляции -
Исходный префикс - 8 , заменяющий префикс - 7
Если поле заменяющий префикс оставить пустым, исходный префикс будет просто отрезан.
Правила трансляции никак не влияют на прохождение звонка и не меняют набранные цифры, они нужны только для 
правильного поиска направления в тарифном плане.
Параметр тарификация в тарифном плане влияет на алгоритм подсчета стоимости звонка.
Первое поле - нетарифицирумые секунды, второе - минимальная биллинговая длительность, третье - биллинговый шаг после превышения
минимальной биллинговой длительности.
Например, посекундная тарификация с первой секунды - 0/1/1
Тарификация 0/30/6 означает, что звонок длительностью меньше 30 сек. будет приравнен к 30 сек. а далее длительность будет округляться с точностью 6 сек. в сторону большего значения.

Тарифы
--------------

В модуле Тарифы можно добавлять, редактировать, удалять тарифы для выбранного тарифного плана.
При добавлении и редактировании можно удобно использовать Справочник кодов, откуда можно непосредственно вставлять направления в тарифный план.
При записи cdr звонка определяется его принадлежность тарифному плану и находится соответствующее направление в данном тарифном плане.
Вначале ищется направление с максимальной длиной совпадания префикса.
Например, если в тарифном плане есть записи Russia proper - 7 и Russia Moscow - 7495, то звонок 7495.... будет определен как Russia Moscow.
Также каждый тариф имеет параметры - минимальная длина (количество цифр) и максимальная длина.
Т.е. звонки с одинаковыми префиксами, но с разной длиной могут быть определены как разные направления.
Например, есть тарифы test1 c префиксом 123 и длиной 4-4, и тариф test2 с префиксом 123 и длиной 5-10.
Тогда звонок с набранными цифрами 1235 будет определен как test1, звонок с набранными цифрами 12356 - как test2.

Если не удалось определить принадлежность звонка ни одному тарифному плану, или в тарифном плане не найдено соответствующего тарифа,
в поле Направление будет записано Unknown и стоимость звонка 0.00.


Отчеты
---------------

Модуль Отчеты позволяет получать разнообразные отчеты с фильтрацией различным параметрам.
Если задан параметр Базовая валюта, то суммарная стоимость будет приводиться к этой валюте по курсам указанным в модуле Валюты.
Если этот параметр не задан, то результат будет выведен в нескольких валютах (если звонки проходили по тарифным планам с разными валютами).





